#include "config.h"
#include "dsp.h"
#include <assert.h>
#include <math.h>
#include <stdbool.h>
#include <stdio.h>

float expected_x[] = {0.        ,    30.04087193,    60.08174387,    90.1226158 ,
         120.16348774,   150.20435967,   180.24523161,   210.28610354,
         240.32697548,   270.36784741,   300.40871935,   330.44959128,
         360.49046322,   390.53133515,   420.57220708,   450.61307902,
         480.65395095,   510.69482289,   540.73569482,   570.77656676,
         600.81743869,   630.85831063,   660.89918256,   690.9400545 ,
         720.98092643,   751.02179837,   781.0626703 ,   811.10354223,
         841.14441417,   871.1852861 ,   901.22615804,   931.26702997,
         961.30790191,   991.34877384,  1021.38964578,  1051.43051771,
        1081.47138965,  1111.51226158,  1141.55313351,  1171.59400545,
        1201.63487738,  1231.67574932,  1261.71662125,  1291.75749319,
        1321.79836512,  1351.83923706,  1381.88010899,  1411.92098093,
        1441.96185286,  1472.0027248 ,  1502.04359673,  1532.08446866,
        1562.1253406 ,  1592.16621253,  1622.20708447,  1652.2479564 ,
        1682.28882834,  1712.32970027,  1742.37057221,  1772.41144414,
        1802.45231608,  1832.49318801,  1862.53405995,  1892.57493188,
        1922.61580381,  1952.65667575,  1982.69754768,  2012.73841962,
        2042.77929155,  2072.82016349,  2102.86103542,  2132.90190736,
        2162.94277929,  2192.98365123,  2223.02452316,  2253.0653951 ,
        2283.10626703,  2313.14713896,  2343.1880109 ,  2373.22888283,
        2403.26975477,  2433.3106267 ,  2463.35149864,  2493.39237057,
        2523.43324251,  2553.47411444,  2583.51498638,  2613.55585831,
        2643.59673025,  2673.63760218,  2703.67847411,  2733.71934605,
        2763.76021798,  2793.80108992,  2823.84196185,  2853.88283379,
        2883.92370572,  2913.96457766,  2944.00544959,  2974.04632153,
        3004.08719346,  3034.1280654 ,  3064.16893733,  3094.20980926,
        3124.2506812 ,  3154.29155313,  3184.33242507,  3214.373297  ,
        3244.41416894,  3274.45504087,  3304.49591281,  3334.53678474,
        3364.57765668,  3394.61852861,  3424.65940054,  3454.70027248,
        3484.74114441,  3514.78201635,  3544.82288828,  3574.86376022,
        3604.90463215,  3634.94550409,  3664.98637602,  3695.02724796,
        3725.06811989,  3755.10899183,  3785.14986376,  3815.19073569,
        3845.23160763,  3875.27247956,  3905.3133515 ,  3935.35422343,
        3965.39509537,  3995.4359673 ,  4025.47683924,  4055.51771117,
        4085.55858311,  4115.59945504,  4145.64032698,  4175.68119891,
        4205.72207084,  4235.76294278,  4265.80381471,  4295.84468665,
        4325.88555858,  4355.92643052,  4385.96730245,  4416.00817439,
        4446.04904632,  4476.08991826,  4506.13079019,  4536.17166213,
        4566.21253406,  4596.25340599,  4626.29427793,  4656.33514986,
        4686.3760218 ,  4716.41689373,  4746.45776567,  4776.4986376 ,
        4806.53950954,  4836.58038147,  4866.62125341,  4896.66212534,
        4926.70299728,  4956.74386921,  4986.78474114,  5016.82561308,
        5046.86648501,  5076.90735695,  5106.94822888,  5136.98910082,
        5167.02997275,  5197.07084469,  5227.11171662,  5257.15258856,
        5287.19346049,  5317.23433243,  5347.27520436,  5377.31607629,
        5407.35694823,  5437.39782016,  5467.4386921 ,  5497.47956403,
        5527.52043597,  5557.5613079 ,  5587.60217984,  5617.64305177,
        5647.68392371,  5677.72479564,  5707.76566757,  5737.80653951,
        5767.84741144,  5797.88828338,  5827.92915531,  5857.97002725,
        5888.01089918,  5918.05177112,  5948.09264305,  5978.13351499,
        6008.17438692,  6038.21525886,  6068.25613079,  6098.29700272,
        6128.33787466,  6158.37874659,  6188.41961853,  6218.46049046,
        6248.5013624 ,  6278.54223433,  6308.58310627,  6338.6239782 ,
        6368.66485014,  6398.70572207,  6428.74659401,  6458.78746594,
        6488.82833787,  6518.86920981,  6548.91008174,  6578.95095368,
        6608.99182561,  6639.03269755,  6669.07356948,  6699.11444142,
        6729.15531335,  6759.19618529,  6789.23705722,  6819.27792916,
        6849.31880109,  6879.35967302,  6909.40054496,  6939.44141689,
        6969.48228883,  6999.52316076,  7029.5640327 ,  7059.60490463,
        7089.64577657,  7119.6866485 ,  7149.72752044,  7179.76839237,
        7209.80926431,  7239.85013624,  7269.89100817,  7299.93188011,
        7329.97275204,  7360.01362398,  7390.05449591,  7420.09536785,
        7450.13623978,  7480.17711172,  7510.21798365,  7540.25885559,
        7570.29972752,  7600.34059946,  7630.38147139,  7660.42234332,
        7690.46321526,  7720.50408719,  7750.54495913,  7780.58583106,
        7810.626703  ,  7840.66757493,  7870.70844687,  7900.7493188 ,
        7930.79019074,  7960.83106267,  7990.8719346 ,  8020.91280654,
        8050.95367847,  8080.99455041,  8111.03542234,  8141.07629428,
        8171.11716621,  8201.15803815,  8231.19891008,  8261.23978202,
        8291.28065395,  8321.32152589,  8351.36239782,  8381.40326975,
        8411.44414169,  8441.48501362,  8471.52588556,  8501.56675749,
        8531.60762943,  8561.64850136,  8591.6893733 ,  8621.73024523,
        8651.77111717,  8681.8119891 ,  8711.85286104,  8741.89373297,
        8771.9346049 ,  8801.97547684,  8832.01634877,  8862.05722071,
        8892.09809264,  8922.13896458,  8952.17983651,  8982.22070845,
        9012.26158038,  9042.30245232,  9072.34332425,  9102.38419619,
        9132.42506812,  9162.46594005,  9192.50681199,  9222.54768392,
        9252.58855586,  9282.62942779,  9312.67029973,  9342.71117166,
        9372.7520436 ,  9402.79291553,  9432.83378747,  9462.8746594 ,
        9492.91553134,  9522.95640327,  9552.9972752 ,  9583.03814714,
        9613.07901907,  9643.11989101,  9673.16076294,  9703.20163488,
        9733.24250681,  9763.28337875,  9793.32425068,  9823.36512262,
        9853.40599455,  9883.44686649,  9913.48773842,  9943.52861035,
        9973.56948229, 10003.61035422, 10033.65122616, 10063.69209809,
       10093.73297003, 10123.77384196, 10153.8147139 , 10183.85558583,
       10213.89645777, 10243.9373297 , 10273.97820163, 10304.01907357,
       10334.0599455 , 10364.10081744, 10394.14168937, 10424.18256131,
       10454.22343324, 10484.26430518, 10514.30517711, 10544.34604905,
       10574.38692098, 10604.42779292, 10634.46866485, 10664.50953678,
       10694.55040872, 10724.59128065, 10754.63215259, 10784.67302452,
       10814.71389646, 10844.75476839, 10874.79564033, 10904.83651226,
       10934.8773842 , 10964.91825613, 10994.95912807, 11025.        ,
       11055.04087193, 11085.08174387, 11115.1226158 , 11145.16348774,
       11175.20435967, 11205.24523161, 11235.28610354, 11265.32697548,
       11295.36784741, 11325.40871935, 11355.44959128, 11385.49046322,
       11415.53133515, 11445.57220708, 11475.61307902, 11505.65395095,
       11535.69482289, 11565.73569482, 11595.77656676, 11625.81743869,
       11655.85831063, 11685.89918256, 11715.9400545 , 11745.98092643,
       11776.02179837, 11806.0626703 , 11836.10354223, 11866.14441417,
       11896.1852861 , 11926.22615804, 11956.26702997, 11986.30790191,
       12016.34877384, 12046.38964578, 12076.43051771, 12106.47138965,
       12136.51226158, 12166.55313351, 12196.59400545, 12226.63487738,
       12256.67574932, 12286.71662125, 12316.75749319, 12346.79836512,
       12376.83923706, 12406.88010899, 12436.92098093, 12466.96185286,
       12497.0027248 , 12527.04359673, 12557.08446866, 12587.1253406 ,
       12617.16621253, 12647.20708447, 12677.2479564 , 12707.28882834,
       12737.32970027, 12767.37057221, 12797.41144414, 12827.45231608,
       12857.49318801, 12887.53405995, 12917.57493188, 12947.61580381,
       12977.65667575, 13007.69754768, 13037.73841962, 13067.77929155,
       13097.82016349, 13127.86103542, 13157.90190736, 13187.94277929,
       13217.98365123, 13248.02452316, 13278.0653951 , 13308.10626703,
       13338.14713896, 13368.1880109 , 13398.22888283, 13428.26975477,
       13458.3106267 , 13488.35149864, 13518.39237057, 13548.43324251,
       13578.47411444, 13608.51498638, 13638.55585831, 13668.59673025,
       13698.63760218, 13728.67847411, 13758.71934605, 13788.76021798,
       13818.80108992, 13848.84196185, 13878.88283379, 13908.92370572,
       13938.96457766, 13969.00544959, 13999.04632153, 14029.08719346,
       14059.1280654 , 14089.16893733, 14119.20980926, 14149.2506812 ,
       14179.29155313, 14209.33242507, 14239.373297  , 14269.41416894,
       14299.45504087, 14329.49591281, 14359.53678474, 14389.57765668,
       14419.61852861, 14449.65940054, 14479.70027248, 14509.74114441,
       14539.78201635, 14569.82288828, 14599.86376022, 14629.90463215,
       14659.94550409, 14689.98637602, 14720.02724796, 14750.06811989,
       14780.10899183, 14810.14986376, 14840.19073569, 14870.23160763,
       14900.27247956, 14930.3133515 , 14960.35422343, 14990.39509537,
       15020.4359673 , 15050.47683924, 15080.51771117, 15110.55858311,
       15140.59945504, 15170.64032698, 15200.68119891, 15230.72207084,
       15260.76294278, 15290.80381471, 15320.84468665, 15350.88555858,
       15380.92643052, 15410.96730245, 15441.00817439, 15471.04904632,
       15501.08991826, 15531.13079019, 15561.17166213, 15591.21253406,
       15621.25340599, 15651.29427793, 15681.33514986, 15711.3760218 ,
       15741.41689373, 15771.45776567, 15801.4986376 , 15831.53950954,
       15861.58038147, 15891.62125341, 15921.66212534, 15951.70299728,
       15981.74386921, 16011.78474114, 16041.82561308, 16071.86648501,
       16101.90735695, 16131.94822888, 16161.98910082, 16192.02997275,
       16222.07084469, 16252.11171662, 16282.15258856, 16312.19346049,
       16342.23433243, 16372.27520436, 16402.31607629, 16432.35694823,
       16462.39782016, 16492.4386921 , 16522.47956403, 16552.52043597,
       16582.5613079 , 16612.60217984, 16642.64305177, 16672.68392371,
       16702.72479564, 16732.76566757, 16762.80653951, 16792.84741144,
       16822.88828338, 16852.92915531, 16882.97002725, 16913.01089918,
       16943.05177112, 16973.09264305, 17003.13351499, 17033.17438692,
       17063.21525886, 17093.25613079, 17123.29700272, 17153.33787466,
       17183.37874659, 17213.41961853, 17243.46049046, 17273.5013624 ,
       17303.54223433, 17333.58310627, 17363.6239782 , 17393.66485014,
       17423.70572207, 17453.74659401, 17483.78746594, 17513.82833787,
       17543.86920981, 17573.91008174, 17603.95095368, 17633.99182561,
       17664.03269755, 17694.07356948, 17724.11444142, 17754.15531335,
       17784.19618529, 17814.23705722, 17844.27792916, 17874.31880109,
       17904.35967302, 17934.40054496, 17964.44141689, 17994.48228883,
       18024.52316076, 18054.5640327 , 18084.60490463, 18114.64577657,
       18144.6866485 , 18174.72752044, 18204.76839237, 18234.80926431,
       18264.85013624, 18294.89100817, 18324.93188011, 18354.97275204,
       18385.01362398, 18415.05449591, 18445.09536785, 18475.13623978,
       18505.17711172, 18535.21798365, 18565.25885559, 18595.29972752,
       18625.34059946, 18655.38147139, 18685.42234332, 18715.46321526,
       18745.50408719, 18775.54495913, 18805.58583106, 18835.626703  ,
       18865.66757493, 18895.70844687, 18925.7493188 , 18955.79019074,
       18985.83106267, 19015.8719346 , 19045.91280654, 19075.95367847,
       19105.99455041, 19136.03542234, 19166.07629428, 19196.11716621,
       19226.15803815, 19256.19891008, 19286.23978202, 19316.28065395,
       19346.32152589, 19376.36239782, 19406.40326975, 19436.44414169,
       19466.48501362, 19496.52588556, 19526.56675749, 19556.60762943,
       19586.64850136, 19616.6893733 , 19646.73024523, 19676.77111717,
       19706.8119891 , 19736.85286104, 19766.89373297, 19796.9346049 ,
       19826.97547684, 19857.01634877, 19887.05722071, 19917.09809264,
       19947.13896458, 19977.17983651, 20007.22070845, 20037.26158038,
       20067.30245232, 20097.34332425, 20127.38419619, 20157.42506812,
       20187.46594005, 20217.50681199, 20247.54768392, 20277.58855586,
       20307.62942779, 20337.67029973, 20367.71117166, 20397.7520436 ,
       20427.79291553, 20457.83378747, 20487.8746594 , 20517.91553134,
       20547.95640327, 20577.9972752 , 20608.03814714, 20638.07901907,
       20668.11989101, 20698.16076294, 20728.20163488, 20758.24250681,
       20788.28337875, 20818.32425068, 20848.36512262, 20878.40599455,
       20908.44686649, 20938.48773842, 20968.52861035, 20998.56948229,
       21028.61035422, 21058.65122616, 21088.69209809, 21118.73297003,
       21148.77384196, 21178.8147139 , 21208.85558583, 21238.89645777,
       21268.9373297 , 21298.97820163, 21329.01907357, 21359.0599455 ,
       21389.10081744, 21419.14168937, 21449.18256131, 21479.22343324,
       21509.26430518, 21539.30517711, 21569.34604905, 21599.38692098,
       21629.42779292, 21659.46866485, 21689.50953678, 21719.55040872,
       21749.59128065, 21779.63215259, 21809.67302452, 21839.71389646,
       21869.75476839, 21899.79564033, 21929.83651226, 21959.8773842 ,
       21989.91825613, 22019.95912807, 22050.        };

float expected_mel_y_23[] = {
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.00582858, 0.03200268, 0.05817679, 0.0843509,  0.110525,
    0.13669911, 0.16287322, 0.18904732, 0.21522143, 0.24139554, 0.26756964,
    0.29374375, 0.31991786, 0.34609196, 0.37226607, 0.39844018, 0.42461428,
    0.45078839, 0.4769625,  0.5031366,  0.52931071, 0.55548481, 0.58165892,
    0.60783303, 0.63400713, 0.66018124, 0.68635535, 0.71252945, 0.73870356,
    0.76487767, 0.79105177, 0.81722588, 0.84339999, 0.86957409, 0.8957482,
    0.92192231, 0.94809641, 0.97427052, 0.99960004, 0.97605555, 0.95251105,
    0.92896655, 0.90542205, 0.88187756, 0.85833306, 0.83478856, 0.81124407,
    0.78769957, 0.76415507, 0.74061058, 0.71706608, 0.69352158, 0.66997708,
    0.64643259, 0.62288809, 0.59934359, 0.5757991,  0.5522546,  0.5287101,
    0.5051656,  0.48162111, 0.45807661, 0.43453211, 0.41098762, 0.38744312,
    0.36389862, 0.34035412, 0.31680963, 0.29326513, 0.26972063, 0.24617614,
    0.22263164, 0.19908714, 0.17554264, 0.15199815, 0.12845365, 0.10490915,
    0.08136466, 0.05782016, 0.03427566, 0.01073117, 0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.,         0.,         0.,         0.,
    0.,         0.,         0.};
int main() {

  size_t mic_rate = 44100;
  size_t n_rolling_history = 2;
  size_t fps = 60;
  size_t n_fft_bins = 24;
  size_t freq_min = 200;
  size_t freq_max = 12000;
  mel_bank x = create_mel_bank(mic_rate, n_rolling_history, fps, n_fft_bins,
                               freq_min, freq_max);

  size_t samples = mic_rate * n_rolling_history / (2.0 * fps);

  // figure out why this epsilon is so large
  float epsilon = 1e-3;
  bool pass = true;
  for (size_t i = 0; i < samples; i++) {
    if (fabs(x.mel_x[i] - expected_x[i]) > epsilon) {
      pass = false;
      printf("Expected %f, got %f \n", expected_x[i], x.mel_x[i]);
    }
  }

  epsilon = 1e-5;
  for (size_t i = 0; i < samples; i++) {
    if (fabs(x.mel_y[23 * samples + i] - expected_mel_y_23[i]) > epsilon) {
      pass = false;
      printf("Expected %f, got %f at index %d\n", expected_mel_y_23[i],
             x.mel_y[23 * samples + i], (int)i);
    }
  }

  destroy_mel_bank(x);

  if (pass) {
    return 0;
  } else {
    return -1;
  }
}
