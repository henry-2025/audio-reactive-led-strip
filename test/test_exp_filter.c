#include "dsp.h"
#include <stdbool.h>

float expected[] = {
    0.19133972, 0.0466747,  0.78939848, 0.12620031, 0.84045104, 0.12606363,
    0.09315127, 0.27223475, 0.32086958, 0.54406098, 0.27306298, 0.07422397,
    0.3567698,  0.63903146, 0.54285225, 0.8732071,  0.05015262, 0.17689518,
    0.21245038, 0.39821787, 0.17053282, 0.96182047, 0.19629877, 0.16890264,
    0.42743507, 0.05561293, 0.64582918, 0.28475749, 0.38559554, 0.30715199,
    0.06509077, 0.56056894, 0.74032583, 0.58646942, 0.14819371, 0.71098846,
    0.10836583, 0.18009493, 1.03677603, 0.0939396,  0.19987542, 0.71693586,
    0.75004527, 0.62607192, 0.81776577, 0.55823947, 0.60164642, 0.32214651,
    0.25142108, 0.01572098, 0.98233563, 0.08420938, 0.20684954, 1.47828133,
    0.56246047, 0.66047807, 0.439108,   0.21602114, 0.56722197, 0.43276743,
    0.38860071, 0.50480968, 0.28100791, 0.09338005, 0.3620024,  1.01813112,
    0.88354865, 0.17115398, 0.38873698, 0.13448836, 0.01481685, 1.08462796,
    0.42399389, 0.15059725, 0.21701932, 0.22097095, 0.20424413, 0.06263462,
    0.67498377, 1.14723017, 0.14540819, 0.15239976, 0.31702893, 0.39450086,
    1.24415747, 0.14300254, 0.12849241, 0.25839275, 0.10482977, 0.17225263,
    0.13979815, 0.37850805, 0.67066182, 0.13482642, 0.23988855, 0.09029223,
    0.58151291, 0.36260366, 0.15923866, 0.9093225,  0.29593426, 1.26483096,
    0.03955397, 0.28615806, 0.25365253, 0.25355763, 0.69417152, 0.61566914,
    0.29388144, 0.23124628, 0.18343216, 0.13974017, 0.77269906, 0.4325813,
    0.14269003, 0.14469567, 0.45572424, 1.16938906, 1.21256352, 0.60719386,
    0.36757455, 0.39430982, 0.61748262, 0.29613119, 1.12228896, 0.28436277,
    0.00991962};

float update[] = {
    3.72679438e-01, 8.33493948e-02, 1.56879697e+00, 2.42400624e-01,
    1.67090209e+00, 2.42127251e-01, 1.76302539e-01, 5.34469501e-01,
    6.31739156e-01, 1.07812196e+00, 5.36125964e-01, 1.38447941e-01,
    7.03539597e-01, 1.26806292e+00, 1.07570449e+00, 1.73641420e+00,
    9.03052314e-02, 3.43790353e-01, 4.14900752e-01, 7.86435734e-01,
    3.31065632e-01, 1.91364094e+00, 3.82597547e-01, 3.27805286e-01,
    8.44870141e-01, 1.01225865e-01, 1.28165836e+00, 5.59514986e-01,
    7.61191086e-01, 6.04303975e-01, 1.20181532e-01, 1.11113788e+00,
    1.47065166e+00, 1.16293883e+00, 2.86387423e-01, 1.41197693e+00,
    2.06731657e-01, 3.50189855e-01, 2.06355207e+00, 1.77879204e-01,
    3.89750849e-01, 1.42387171e+00, 1.49009053e+00, 1.24214383e+00,
    1.62553154e+00, 1.10647894e+00, 1.19329284e+00, 6.34293020e-01,
    4.92842163e-01, 2.14419542e-02, 1.95467126e+00, 1.58418753e-01,
    4.03699089e-01, 2.94656267e+00, 1.11492094e+00, 1.31095615e+00,
    8.68216009e-01, 4.22042283e-01, 1.12444395e+00, 8.55534859e-01,
    7.67201418e-01, 9.99619357e-01, 5.52015829e-01, 1.76760109e-01,
    7.14004797e-01, 2.02626224e+00, 1.75709730e+00, 3.32307967e-01,
    7.67473965e-01, 2.58976729e-01, 1.96337098e-02, 2.15925591e+00,
    8.37987784e-01, 2.91194494e-01, 4.24038647e-01, 4.31941904e-01,
    3.98488252e-01, 1.15269235e-01, 1.33996755e+00, 2.28446035e+00,
    2.80816374e-01, 2.94799529e-01, 6.24057863e-01, 7.79001725e-01,
    2.47831494e+00, 2.76005083e-01, 2.46984811e-01, 5.06785503e-01,
    1.99659542e-01, 3.34505257e-01, 2.69596305e-01, 7.47016091e-01,
    1.33132365e+00, 2.59652834e-01, 4.69777095e-01, 1.70584454e-01,
    1.15302582e+00, 7.15207317e-01, 3.08477316e-01, 1.80864500e+00,
    5.81868530e-01, 2.51966192e+00, 6.91079306e-02, 5.62316112e-01,
    4.97305052e-01, 4.97115255e-01, 1.37834304e+00, 1.22133827e+00,
    5.77762874e-01, 4.52492560e-01, 3.56864318e-01, 2.69480333e-01,
    1.53539812e+00, 8.55162608e-01, 2.75380050e-01, 2.79391331e-01,
    9.01448475e-01, 2.32877813e+00, 2.41512705e+00, 1.20438772e+00,
    7.25149099e-01, 7.78619649e-01, 1.22496524e+00, 5.82262387e-01,
    2.23457791e+00, 5.58725532e-01, 1.96216942e-03};

float current[127];
float epsilon = 0.00001;

int main() {
  for (int i = 0; i < 127; i++) {
    current[i] = 0.01;
  }

  exp_filter_array(127, current, update, 0.01, 0.5);

  bool fail = false;
  for (int i = 0; i < 127; i++) {
    if (fabs(current[i] - expected[i]) > epsilon) {
        printf("Got: %f, expected: %f\n", current[i], expected[i]);
      fail = true;
    }
  }
  if (fail) {
    return -1;
  } else {
    return 0;
  }
}
