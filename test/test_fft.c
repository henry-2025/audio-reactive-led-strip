#include "dsp.h"
#include <fftw3.h>
#include <stdbool.h>
#include <string.h>

double input[] = {
    1.48094528,  0.59696835,  -0.95853714, 2.06560912,  -0.48211678,
    2.65378565,  -1.63017596, -1.7736234,  -0.18237599, 0.78558729,
    1.92762221,  -0.11180059, -0.37506153, 1.76112525,  0.86316855,
    -0.64965065, -0.62537752, -1.20447363, -2.01692314, 0.10712862,
    1.17423722,  -0.62542565, 1.16431726,  -0.6035666,  -0.17092301,
    2.22440035,  0.69971944,  -0.23871011, -0.75631096, 0.18585501,
    0.48200846,  1.03091996,  0.3238756,   0.76963387,  -0.22378036,
    -0.0591962,  0.0908271,   -0.36701689, -0.92282657, -0.44215906,
    -0.87652361, 0.26975025,  1.0402947,   0.09392486,  -0.45810233,
    -1.75546854, -0.11624388, -0.01373014, 0.26311115,  0.8972705,
    0.72080431,  0.29768675,  -0.49910996, 0.26488135,  0.21259605,
    0.28471469,  -0.47448167, -1.5913399,  0.90448678,  -0.66089208,
    0.12687497,  -1.12807841, 0.72215092,  -0.37211337, 0.43200432,
    0.25162815,  0.25028231,  -1.1038772,  -0.39124264, -0.51855742,
    0.52418886,  0.35077276,  -0.33244553, -0.41294771, -0.32350463,
    -0.00789725, -0.86683017, -0.42526519, -1.71192727, 0.18745107,
    0.02441095,  0.14731432,  -1.22928049, 0.66580587,  -0.99368776,
    -1.20580196, -0.17206011, 0.29488154,  1.52847238,  0.33654293,
    -0.25829216, -0.41296341, -0.63304026, 0.40210274,  0.92177561,
    -1.89623355, -0.70084883, 1.17562188,  -0.69704496, -0.01975832,
    0.27325999,  1.24249352,  0.95413082,  0.89987305,  -0.79308366,
    0.86759218,  0.78226561,  0.01063997,  -0.3325533,  0.20462194,
    0.78163695,  -0.90694826, -0.14670344, -1.55923589, 0.88154475,
    -0.31585416, 0.53328458,  0.19075993,  -0.31190746, 1.40099541,
    0.59151294,  -0.68778615, -0.46705669, -0.6522581,  0.32920506,
    0.15964008,  0.53220806,  -0.82599626};

double expected[] = {
    0.93619659,  12.07992828, 4.62251223,  5.32819342,  7.58289659,
    8.5404077,   7.11749831,  12.40593877, 5.7864796,   3.62987399,
    13.4648943,  8.12444372,  10.95093531, 18.45956652, 4.74087849,
    6.01085309,  3.56161329,  16.17553834, 2.48966423,  3.36533988,
    8.56811354,  4.10135118,  8.28576614,  24.05581369, 9.50480157,
    7.09236442,  10.27192606, 3.0066255,   15.08569502, 18.37175771,
    12.24048181, 11.07806431, 9.59349492,  7.24682706,  2.60169519,
    7.02964612,  6.45974591,  1.82847498,  9.18781832,  1.26217906,
    13.4251645,  7.15893595,  5.61697548,  7.80729343,  4.20309911,
    12.49600029, 18.08385135, 7.20190626,  6.13260927,  7.91904732,
    2.85813122,  7.13626733,  7.17952119,  14.43491241, 17.27436244,
    7.49754677,  11.34455882, 5.11730567,  6.46300368,  16.18436041,
    10.91069978, 10.07467636, 10.88957515, 4.50117537,  0.12250971};

double input2[] = {
    -0.98893223, -0.1981178,  -0.00566655, -0.30376356, -0.15322171,
    0.19130029,  1.01603334,  0.07035506,  0.43665254,  -1.71464935,
    0.05042967,  0.10596578,  0.08730763,  -1.44042518, -0.93354647,
    0.57484066,  0.99404588,  -0.74584882, 1.39605645,  0.31686228,
    -0.35417826, -1.52639561, 0.8686169,   0.1259143,   1.43092503,
    1.53755933,  -0.77033474, 0.96464444,  1.17490517,  1.91003804,
    -0.0857907,  1.30102836,  -0.34511738, -0.62398609, -0.01700517,
    -0.09604874, -0.60634896, -1.01563427, 0.0804605,   -0.27870409,
    -0.67119646, 0.07545303,  -0.28249496, -0.38023875, -0.34116116,
    0.916151,    -0.36995086, 1.26779199,  0.94843743,  1.03273627,
    1.15073375,  0.0136817,   -0.67251172, 0.67499933,  0.74374384,
    -0.51107624, 2.21991293,  -0.61835036, -0.2279588,  -1.07874753,
    -0.11175827, -1.28272647, -1.13720588, 0.59350128,  0.02098996,
    0.41173693,  -0.895859,   -0.78287344, 0.50584835,  0.20184047,
    0.39730409,  -0.95784399, 0.93266466,  -0.1642694,  0.62093566,
    -0.12001978, -1.34551142, -0.34819227, 1.76179543,  -1.76396173,
    -0.64032678, 1.50877968,  -0.42367623, 2.16597383,  -0.24656702,
    0.2618185,   -0.21021048, 0.14515717,  -0.94052467, 0.55040947,
    1.12195168,  0.47445817,  -0.84831885, 1.03104605,  -1.27334136,
    -1.04865035, 0.18447493,  0.94466451,  0.90531906,  -0.32332399,
    -0.83745153, -1.15569837, -1.50541734, 2.77153234,  0.88712875,
    1.66030967,  1.15153214,  -0.08611678, -0.20873147, -1.10471861,
    -0.07999245, -0.02076626, -0.2248438,  -0.04289259, 0.99853719,
    -0.49944666, 1.96711908,  -0.6780816,  0.03274457,  -0.38668573,
    -0.30803895, -0.93015811, -0.17792491, 0.62473295,  -0.63115058,
    -1.32446525, 1.08018192,  0.52885091};

double expected2[] = {
    7.69577743,  2.62287029,  10.01411468, 3.85282418,  10.81975165,
    16.49297318, 14.30499993, 10.4859125,  4.40348769,  5.56751058,
    9.91837049,  4.71902518,  11.95816927, 15.32312648, 2.70478977,
    13.1072803,  15.29854687, 7.64396501,  13.56666816, 16.23310527,
    1.02985706,  14.11000968, 12.20873364, 3.22182731,  4.82327246,
    3.34067801,  11.07206474, 7.47018391,  4.07894719,  12.82418822,
    0.73430747,  17.49504071, 6.53712826,  7.11302031,  5.64773893,
    10.65740371, 4.93400085,  4.69097768,  12.06268886, 19.75054915,
    3.16489861,  14.05630668, 14.50266619, 9.95938023,  6.70953513,
    5.84247465,  10.13910577, 8.85252002,  0.34389655,  5.45729717,
    13.37242826, 17.45610918, 6.185361,    5.69964193,  7.92376485,
    1.59738062,  9.14764518,  18.59852037, 12.81477622, 6.36580449,
    8.41633164,  9.44308588,  17.61807186, 7.92132952,  4.89326539};

int main() {

  rfft f = new_rfft(128);
  memcpy(f.in, input, 128 * sizeof(double));
  run_rfft(f);
  bool pass = true;
  double epsilon = 0.0001;
  for (int i = 0; i < 128 / 2; i++) {
    if (fabs(f.out[i] - expected[i]) > epsilon) {
      pass = false;
      printf("Expected: %f Got: %f\n", expected[i], f.out[i]);
    }
  }

  // run again
  memcpy(f.in, input2, 128 * sizeof(double));
  run_rfft(f);

  for (int i = 0; i < 128 / 2; i++) {
    if (fabs(f.out[i] - expected2[i]) > epsilon) {
      pass = false;
      printf("Expected: %f Got: %f\n", expected[i], f.out[i]);
    }
  }

  destroy_rfft(f);
  if (pass) {
    return 0;
  } else {
    return -1;
  }
  return 0;
}
